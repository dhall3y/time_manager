language: generic

services:
  - docker

before_install:
  - echo $ENCODED_SSH_KEY | base64 --decode > TimeManagerKeys.pem
  - chmod 600 TimeManagerKeys.pem
  - echo $(head -c 50 TimeManagerKeys.pem)
  - docker-compose build


script:
  - docker-compose up -d

after_success:
  - echo "$DOCKER_ACCESS_TOKEN" | docker login -u webdesignpastor --password-stdin
  - docker-compose push back
  - docker-compose push front

jobs:
  include:
    - stage: Deploy
      script:
        - ssh -o StrictHostKeyChecking=no -i TimeManagerKeys.pem ec2-user@16.16.25.106 "docker-compose pull && docker-compose up -d"
